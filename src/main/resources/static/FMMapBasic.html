<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基础地图显示</title>
    <link rel="stylesheet" href="lib/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div id="fengMap"></div>
<!--距离时间显示-->

<!--操作按钮-->
<button class="btn btn-default operating btn-primary" id="btn1">隐藏放大缩小控件</button>

<!--距离时间显示-->
<div id="description"></div>

<script src="lib/jquery-2.1.4.min.js"></script>
<script src="lib/fengmap.min.js"></script>
<script src="lib/bootstrap.min.js"></script>
<script>
    //获取版本号,设置title
    document.title = '基础地图显示V' + fengmap.VERSION;

    //定义全局map变量
    var map;
    var zoomVisible = true;
    var fmapID = 'iotlab';

    window.onload = function () {
        //放大、缩小控件配置
        var ctlOpt1 = new fengmap.controlOptions({
            //设置显示的位置为左上角
            position: fengmap.controlPositon.LEFT_TOP,
            //位置x,y的偏移量
            offset: {
                x: 20,
                y: 60
            },
            scaleLevelcallback: function(level, result) {
                carInfo(result);
                /*当前级别：map.mapScaleLevel
                 最小级别：map._minMapScaleLevel
                 最大级别：map._maxMapScaleLevel*/
            }
        });

        map = new fengmap.FMMap({
            //渲染dom
            container: document.getElementById('fengMap'),
            //地图数据位置
            mapServerURL: './data/' + fmapID,
            //主题数据位置
            mapThemeURL: './data/theme',
            //设置主题
            defaultThemeName: 'iotlab',
            // 默认比例尺级别设置为20级
            defaultMapScaleLevel: 20,
            //开发者申请应用下web服务的key
            key: '34a37f702ce7100a9043b5ef4d583500',
            //开发者申请应用名称
            appName: '蜂鸟室内地图测试',
        });

        map.on('loadComplete',function() {
            //放大、缩小控件
            var zoomControl = new fengmap.zoomControl(map, ctlOpt1);

            //显示放大缩小控件
            gui.showZoom(zoomVisible);
        });

        var oBtn = document.querySelector('#btn1');
        //放大缩小控件显示隐藏事件
        oBtn.onclick = function() {
            zoomVisible = !zoomVisible;
            //设置放大缩小控件显示隐藏
            gui.showZoom(zoomVisible);
            if (!zoomVisible) {
                this.innerHTML = "显示放大缩小控件";
                this.classList.remove('btn-primary');
            } else {
                this.innerHTML = "隐藏放大缩小控件";
                this.classList.add('btn-primary');
            }
        };


        //地图点击事件
        map.on('mapClickNode', function (event) {
            //获取坐标信息
            var eventInfo = event.eventInfo.coord;

            //获取焦点层
            var currentGid = map.focusGroupID;

            //获取x、y坐标
            if (eventInfo) { //pc端
                var coord = {
//                        x: event.eventInfo.coord.x,
//                        y: event.eventInfo.coord.y,
                    x: 12735847,
                    y: 3569542,
                }
            } else { //移动端
                var coord = {
                    x: event.mapCoord.x,
                    y: event.mapCoord.y,
                }
            }

            //获取鼠标点击的坐标
            var domEvent = event.eventInfo.domEvent;
            var _x, _y;

            if (domEvent instanceof MouseEvent) {
                _x = domEvent.clientX;
                _y = domEvent.clientY;
            } else {
                _x = domEvent.changedTouches[0].clientX;
                _y = domEvent.changedTouches[0].clientY;
            }

//                //如果点击的是空白处
//                if (!event.nodeType) {
//                    showPrompt(currentGid, {
//                        x: _x,
//                        y: _y,
//                        z: map.getGroupHeight(currentGid) + map.layerLocalHeight
//                    });
//                    return;
//                }
//                showPrompt(currentGid, {
//                    x: _x,
//                    y: _y,
//                    z: map.getGroupHeight(currentGid) + map.layerLocalHeight
//                });

            //清除已存在图层
            var layer = map.getLayerByAlias(currentGid, 'imageMarker');
            if (layer) {
                //自杀式删除
                layer.dispose();
            }

            //添加Marker
            addMarker(currentGid, coord);
        });

        //在点击的位置添加图片标注
        function addMarker(gid, coord) {
            var group = map.getFMGroup(gid);

            //返回当前层中第一个imageMarkerLayer,如果没有，则自动创建
            var layer = group.getOrCreateLayer('imageMarker');

            var im = new fengmap.FMImageMarker({
                x: coord.x,
                y: coord.y,
                url: 'image/blueImageMarker.png',
                height: 2,
                size: 32,
            });
            layer.addMarker(im);
        };

        //打开Fengmap服务器的地图数据和主题
        map.openMapById(fmapID, function (error) {
            //打印错误信息
            console.log(error);
        });
    };
</script>
</body>
</html>